---
title: "Tutorial"
layout: post
---


<iframe src="/assets/plotly_graph.html" onload='javascript:(function(o){o.style.height=o.contentWindow.document.body.scrollHeight+"px";}(this));' style="height:500px;width:100%;border:none;overflow:hidden;"></iframe>





### Intruduction
The National Hockey League (NHL; French: Ligue nationale de hockey—LNH) is a professional ice hockey league in North America comprising 32 teams—25 in the United States and 7 in Canada. It is considered to be the top ranked professional ice hockey league in the world, and is one of the major professional sports leagues in the United States and Canada. The Stanley Cup, the oldest professional sports trophy in North America,is awarded annually to the league playoff champion at the end of each season. The NHL is the fifth-wealthiest professional sport league in the world by revenue, after the National Football League (NFL), Major League Baseball (MLB), the National Basketball Association (NBA), and the English Premier League (EPL)
[https://en.wikipedia.org/wiki/National_Hockey_League]



## Motivation of the project
The purpose of this project is to provide a Python API for accessing NHL game data including plays by plays informations such as game summaries, player stats and play-by-play visualizations. They're all lots good information that is hides on NHL API website scraping process regarding the outputs. In this project we are trying to show all NHL analytics we could like to seek from NHL API.
Our package can extract let's say all most the game summary report as well as show and finally permit advanced data visualisations.
## Tutorial
We provide some functions that accept the target year and a filepath as an argument and then checks at the specified filepath for a file corresponding to the dataset that we are going to download. If it exists, it could immediately open up the file and return the saved contents. If not, it could download the contents from the REST API and save it to the file before returning the data. This means that the first time we run this function, it will automatically download and cache the data locally, and the next time we run the same function, it will instead load the local data.
## Installation
Getting started is as easy as:
Pip install ????
 
## Usage Example 
To download the data for seasons 2017: 
```{python}
get_all_data_by_season(year=2017, out_path="2017")
```
To have in data frame format for spsific game ID :
```{python}
get_goal_shots_data_by_game_id(game_id=2017020001)
```
 Here is a summrize on what we have in our implementation
 ```{python}
 get_json_path(game_id: int):
 ```
 **get_json_path** function takes an input game id and return the location of the json file
```{python}
flatten_player_data(player_list):
 ```
**flatten_player_data** function transform list of players into a flatten encoded string in the form of list of players data.

```{python}    
get_goal_shots_data_by_game_id(game_id: int):
```

**get_goal_shots_data_by_game_id** function transforms the json data into a data frame by filtering the relevant live data of the matchs which is   restricted to Shots and Goals

```{python}    
get_all_relevant_game_ids_by_season(season_year: int):
 ```
**get_all_relevant_game_ids_by_season** function fetches all the game ids having game type Regular Season and Playoffs
```{python}
save_data_to_json(year, game_type, data, save_path)
 ```
**save_data_to_json** function which will help the extracted data from the NHL API locally into a json file
```{python}
get_all_data_by_season(year: int, out_path: str)
```
**get_all_data_by_season**This function will fetch both the games which are regular seasons and playoffs for the entire season

### Interactive Debugging Tool
![](/assets/figures/idt.png)
### Tidy Data
[![](/assets/figures/df.png)](/assets/figures/df.png)

## How to get the number of players in each team

We would first format a tidy dataframe that includes all types of events, with events as rows and including datetime, eventType,
periodType, penaltySeverity, penaltyMinutes, and team, as columns. The events would to be sorted in order of their occurrence in time during the game (datetime).
We would create an empty (np.nan) column for the number of players on ice, and then program a loop to iterate over all event, while concatenating a list of player counts for each time, n_1 and n_2. At the beginning of the loop, and at the beginning of each period
(each time the period of the event is not the same as the previous event), we re-initiate the parameters: n_1 = 6 (number of players in first team, including the goalie), n_2 = 6 (number of players in second team, including the goalie).
Eight parameters would be set: penalty_player_A_team_1=None, end_time_of_penalty_for_player_A_team_1 = Datetime penalty_player_B_team_1 = None, and end_time_of_penalty_for_player_B_team_1=Datetime (as there can be a maximum of 2 players in penalty at the same time);and the four equivalent parameters for team 2. 
Then, as the loop iterater over all events, each time the eventTypeId == "PENALTY", if "penaltySeverity": "Minor" or "DoubleMinor", the number of player in the team involved in the penalty (Team of the player that is penalized) would be substracted 1, the penalty_player would be set to the name the penalized player, and end_time_of_penalty parameter would be set to DateTime + penaltyMinutes. For subsequent events, as long as the penalty_player is not None, the datetime of the event would be compared to end_time_of_penalty, untill datetime > end_time_of_penalty and then the number of player for that team would be added +1, as the player is back on ice.
Note that for other types of penalty (e.g. misconduct), the number of player on the ice would not be updated as an immediate player replacement is allowed.

### Engineering additionnal features 
We would be interested in studying the impact of tackling and hitting on the chance of goals, both (1) at team-level (2 variables), (2) player-level (4 variables), and (3) total through the game (4 variables). Indeed, tackling and hitting has become an important part of hockey, often discussed by commentators, and highly represented in the data under "eventTypeId": "HIT". 
(1) We would first extract, for each shot event, variables at team-level that corresponds to the time (in minutes) between the shot and the last time a player of the team on which the shot was taken was hit. This would be done by iterating through all events in chronological order, initiating the time at as NaN at the beginning of each period, and updating the time at each time a hit happens, for each team. This would result in variables: time_since_last_hit_team_1 and time_since_last_hit_team_2. 
(2) Additionally, during the same iteration process, we would update four boolean variables with player-level information to note whether the hitter and the hittee from the last hit event were among the player involved in the shot (shooter, goalie or assist). This would result in variables: hitter_involved_team_1, hittee_involved_team_1, hitter_involved_team_2, hittee_involved_team_2. 
(3) Finally, to study the relationship between goals and the total number of hits in a game, we would extract 4 variables, during the same iteration process as above. These variables would be initiated at 0 at the beginning of the game, and updated at each hit event for each team and type of player involved (hitter or hittee). This would result in variables: n_hitter_team_1, n_hittee_team_1, n_hitter_team_2, n_hittee_team_2.
### Simple Visualizations
![](/assets/figures/figure_1_goals_by_shot_type_2016.png)

The most dangerous types of shots for this 2016-2017 season are "deflected" (19.8% of success) followed by "tip-in" shots (17.9% of success). By "most dangerous", we mean that these shots are the ones that end up the most frequently by a successfull goal, as opposed to being missed. However, these are among the less frequent ones: there were only 806 "deflected" and 3,267 "tip-in" shots this season. On the contrary, the most common type of shots was by far the "wrist shot", with a total of 38,056 shots of that type for this season.

We chose to illustrate this question with a barplot while overlaying the count of goals in blue overtop the total count of shots in orange (thus, toal of both goals and other, missed shots), by type of shot. Even though there is a large difference between the most common and less common types of shots, we chose to plot the absolute numbers and to keep the scale linear, because these are the most intuitive for the reader to understand the scale (the great number of goals involved in a same season) and not to be confuded with too many percentages on the same figure. We chose to add annotations on top of bars for the percentage of goals over all shots, because these proportion could not be visually abstracted simply from the figure, and this was an intuitive way to illustrate them.


![](/assets/figures/figure_3_goals_by_distance_and_shot_type2017.jpeg)

The proportion of goals over all shots is increases overall exponentially as the distance diminishes, with a maximum proportion of goals >25% when goals are shot at less than 5 feet from the goal. We also note a small, local maximum at 75 to 80 feet. This distribution did not significantly for seasons 2018-19 to 2020-21. This local maximum could suggest that there is another variable (e.g. shot type or other) that could underly this distribution.

We chose this figure after having considered and visualized different types of figures. First, we visualized violinplots of the distribution of goals and missed shots; however, these did not intuitively represent the chance (proportion) of goals over all shots per se, and the result was dependent on some assumption on the kernel size. We also experimented computing a logistic regression to predict goals from distance category, which worked fine.

Finally, we chose to come back to the most simple and intuitive method, which is to bin the distance into categories, and plot the proportion of goals for each bin. We chose to divide the the distance into equal bins (as opposed to percentiles or other kind of distribution), in order to be able to draw direct conclusion about the relationship of goals to the absolute value of distance by visualizing the figure.

![](/assets/figures/figure_2_goal_by_distance2019.jpeg)

Overall, the most dangerous type of shot is the "tip-in" shot taken at a distance of less than 5 feet, followed closely by "back-hand" shots: more than 40% of these shots result in a goal. The relationship found in the previous questions, i.e. that the probability of a goal augments exponentially as the distance decreases, holds true overall for most types of shots. However, the "deflected" and "tip-in" shots have a second maximum between around 30 and 60 feet.

Importantly, the "back-hand" shot has a second maximum at about 80 feet, and the slap-shot has a second maximum at more than 90 feet. This could explain the small local maximum at that distance that we observed in the global distribution of all shots at the previous figure.

Finally, the curves are somewhat irregular, and adding more data (e.g. averaging through a few years) could add more smothness in the results. Note that to have more smoothed curves and remove outliers, we did not plot the points for which we had less than 10 total observations for that type of shot and at that distance in that season.
### Advanced Visualizations: Shot Maps


{% comment %} 
    These commments will not include inside the source.
    ![](/assets/figures/nhl_rink.png)
{% endcomment %}